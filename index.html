<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>20-20-20 Assistant</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<style>
    body {
        background-color: whitesmoke;
    }

    button {
        width: 300px;
    }

    @media screen and (max-width: 600px) {
        .btn.btn-success {
            margin-bottom: 5px;
        }
    }

    #status {
        font-size: 30px;
        color: grey;
        margin-top: 100px;
    }

    .app-title {
        color: steelblue;
    }

    .footer {
        bottom: 0;
        right: 0;
        position: absolute;
        font-size: 13px;
    }
</style>

<body>
    <div class='col'>
        <div class="text-center m-3">
            <img src='./app-icon.png' width="70" height="70" alt='' />
            <h2 class='app-title'>Good Sight</h2>
            <h6>20-20-20 Rule Reminder</h6>
        </div>

        <div class="text-center">
            <button id="btnStart" class="btn btn-success" onclick="start()">Start</button>
            <button id="btnStop" class="btn btn-danger" onclick="stop()" disabled>Stop</button>
        </div>
        <div class="status-container">
            <div id="status" class="text-center"></div>
            <div id="countdown" class="text-center"></div>
        </div>

    </div>

    <span class='m-3 footer'><i>Created by</i> Guster</span>

    <script>
        // You can also require other files to run in this process
        require('./renderer.js')

        const MINS = 20 // 20 minutes
        const SECS = 59

        let mTimer;
        let mCdTimer;
        let mStart = true
        let mCdMin = MINS
        let mCdSec = 0
        let mStartTime

        function start() {
            mStart = true

            setStatus('Started')
            toggleButtonStatus(true)
            startTimer()
        }

        function startTimer() {
            mStartTime = new Date().getTime()
        
            mTimer = setInterval(() => {
                if (!mStart) return

                mStartTime = new Date().getTime()

                // show notification
                new Notification('Time out, now look away!', {
                    requireInteraction: true
                })
            }, MINS * 60 * 1000)

            // the countdown timer
            if (!mCdTimer) {
                startCdTimer()
            }
        }

        function startCdTimer() {
            let countdown = document.getElementById('countdown')
            mCdTimer = setInterval(() => {
                if (!mStart) return

                let now = new Date().getTime()
                let nowMin = Math.max(Math.floor(((now - mStartTime) / 1000) / 60), 1)
                let nowSecond = Math.floor(((now - mStartTime) / 1000) % 60)

                // calculate seconds delta first
                mCdSec = 60 - nowSecond
                mCdMin = MINS - nowMin

                if (mCdSec == 60) {
                    mCdSec = 0;
                }

                updateCdTimer()
            }, 1000);
        }

        function stop() {
            // reset flags
            mStart = false
            mCdMin = MINS
            mCdSec = 0

            // clear timer
            clearTimeout(mTimer)

            // clear countdown timer
            clearTimeout(mCdTimer)
            mCdTimer = null

            // update countdown
            let countdown = document.getElementById('countdown')
            updateCdTimer()

            toggleButtonStatus(false)
            setStatus('Stopped')
        }

        function setStatus(msg) {
            let status = document.getElementById('status')
            status.innerText = msg
        }

        function updateCdTimer() {
            countdown.innerText = `Ready in: ${mCdMin}:${("0" + mCdSec).slice(-2)}`
        }

        function toggleButtonStatus(started) {
            let btnStart = document.getElementById('btnStart')
            let btnStop = document.getElementById('btnStop')
            if (started) {
                btnStart.disabled = true
                btnStop.disabled = false
            } else {
                btnStart.disabled = false
                btnStop.disabled = true
            }
        }

    </script>
</body>

</html>